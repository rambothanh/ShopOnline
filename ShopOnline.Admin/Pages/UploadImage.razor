@page "/uploadimage"
@using System.Text.Json
@inject HttpClient Http
@using System.IO



<h1>Blazor WebAssembly File Upload</h1>

<h3>@message</h3>

<form @onsubmit="OnSubmit">
    <InputFile OnChange="OnInputFileChange" multiple />
    <br /><br />
    <button type="submit">Upload Selected File(s)</button>
</form>


<br>
<div class="container">
    <div class="row">
        <div class="col-sm-2 imgUp">
            <div class="imagePreview"></div>
            <label class="btn btn-primary">Upload<input type="file" class="uploadFile img" value="Upload Photo"
                    style="width: 0px;height: 0px;overflow: hidden;">
            </label>
        </div><!-- col-2 -->
        <i class="fa fa-plus imgAdd"></i>
    </div><!-- row -->
</div><!-- container -->




@code {
    string message = "No file(s) selected";
    IReadOnlyList<IBrowserFile> selectedFiles;

    private void OnInputFileChange(InputFileChangeEventArgs e)
    {
        selectedFiles = e.GetMultipleFiles();
        message = $"{selectedFiles.Count} file(s) selected";
        this.StateHasChanged();
    }

    private async void OnSubmit()
    {
        foreach (var file in selectedFiles)
        {
            Stream stream = file.OpenReadStream();
            MemoryStream ms = new MemoryStream();
            await stream.CopyToAsync(ms);
            stream.Close();
            Models.Entities.Products.UploadImage uploadImage = new Models.Entities.Products.UploadImage();
            uploadImage.FileName = file.Name;
            uploadImage.FileContent = ms.ToArray();
            ms.Close();

            await Http.PostAsJsonAsync<Models.Entities.Products.UploadImage>
                ("UploadImage", uploadImage);
        }
        message = $"{selectedFiles.Count} file(s) uploaded on server";
        this.StateHasChanged();
    }

}
